# Build configuration for Cin7 DSL documentation site with integrated Storybook
# ðŸš¨ EMERGENCY PRODUCTION DEPLOYMENT: 2025-11-10T11:30:00Z - FRAME BREADCRUMBS TEMPLATE FIX
[build]
  base = "polaris/polaris.shopify.com"
  publish = ".next"
  command = "bash ../../scripts/netlify-build.sh"
  # Always build (disable smart build detection to include storybook changes)
  ignore = "exit 1"  # Return non-zero to never skip builds

[build.environment]
  NODE_VERSION = "20.10.0"
  NEXT_TELEMETRY_DISABLED = "1"
  # ðŸš¨ PRODUCTION NUCLEAR cache invalidation - disable ALL caching mechanisms
  NPM_CONFIG_CACHE = "/dev/null"
  NETLIFY_BUILD_CACHE = "false"
  NEXT_FORCE_NO_CACHE = "true"
  YARN_CACHE_FOLDER = "/dev/null"
  NODE_OPTIONS = "--max-old-space-size=4096"
  # ðŸš¨ EMERGENCY PRODUCTION CACHE ANNIHILATION - Frame Breadcrumbs Template Fix
  CACHE_BUST = "EMERGENCY-PRODUCTION-1754822400000-FRAME-BREADCRUMBS-TEMPLATE-FIX"
  FORCE_REBUILD = "true"
  NETLIFY_FORCE_NO_CACHE = "true"
  # ðŸš¨ Bundle hash forcing - emergency fix deployment
  BUNDLE_HASH_FORCE = "EMERGENCY-BUNDLE-1754822400001-FRAME-FIX"
  FRAME_COMPONENT_FORCE = "EMERGENCY-FRAME-1754822400002-PRODUCTION-FIX"
  BREADCRUMBS_COMPONENT_FORCE = "EMERGENCY-BREADCRUMBS-1754822400003-PRODUCTION-FIX"
  TEMPLATE_LITERAL_FORCE = "EMERGENCY-TEMPLATE-1754822400004-PRODUCTION-FIX"
  STORYBOOK_FORCE_REBUILD = "TRUE"
  PRODUCTION_EMERGENCY_DEPLOY = "FRAME-BREADCRUMBS-TEMPLATE-LITERAL-FIX"

[[plugins]]
  package = "@netlify/plugin-nextjs"

# Deny iframe embedding for all pages by default
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    X-Robots-Tag = "noai, noimageai"

# ðŸš¨ EMERGENCY PRODUCTION CDN cache invalidation for all JavaScript bundles
[[headers]]
  for = "*.js"
  [headers.values]
    Cache-Control = "no-cache, no-store, must-revalidate, max-age=0, private"
    Pragma = "no-cache"
    Expires = "0"
    # ðŸš¨ Emergency production cache breakers - Frame Breadcrumbs Template Fix
    X-Cache-Bust = "EMERGENCY-PRODUCTION-1754822400000-FRAME-BREADCRUMBS-TEMPLATE-FIX"
    X-Bundle-Force = "EMERGENCY-BUNDLE-1754822400001-FRAME-FIX"
    X-Frame-Force = "EMERGENCY-FRAME-1754822400002-PRODUCTION-FIX"
    X-Breadcrumbs-Force = "EMERGENCY-BREADCRUMBS-1754822400003-PRODUCTION-FIX"
    X-Template-Force = "EMERGENCY-TEMPLATE-1754822400004-PRODUCTION-FIX"
    X-Storybook-Rebuild = "TRUE"
    X-Production-Emergency = "FRAME-BREADCRUMBS-TEMPLATE-LITERAL-FIX"
    # Force browser to not use any cached version
    Vary = "*"
    Surrogate-Control = "no-store, no-cache, must-revalidate"
    ETag = ""

# Allow Storybook to use iframes (for component previews)
# This must come AFTER /* to override the DENY setting
[[headers]]
  for = "/storybook/*"
  [headers.values]
    X-Frame-Options = "SAMEORIGIN"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    X-Robots-Tag = "noai, noimageai"
    Cache-Control = "no-cache, no-store, must-revalidate, max-age=0"
    X-Cache-Bust = "EMERGENCY-PRODUCTION-1754822400000-FRAME-BREADCRUMBS-TEMPLATE-FIX"
